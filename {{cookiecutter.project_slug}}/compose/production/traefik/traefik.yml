log:
  level: INFO

entryPoints:
  web:
    # http
    address: ':80'
    http:
      # https://docs.traefik.io/routing/entrypoints/#entrypoint
      redirections:
        entryPoint:
          to: web-secure

  web-secure:
    # https
    address: ':443'
  {%- if cookiecutter.use_celery == 'y' %}

  flower:
    address: ':5555'
  {%- endif %}

  {%- if cookiecutter.use_mosquitto == 'y' %}
  mqtt:
    address: ':1883'

  mqtt-secure:
    address: ':8883'
  {%- endif %}

certificatesResolvers:
  letsencrypt:
    # https://docs.traefik.io/master/https/acme/#lets-encrypt
    acme:
      email: '{{ cookiecutter.email }}'
      storage: /etc/traefik/acme/acme.json
      # https://docs.traefik.io/master/https/acme/#httpchallenge
      httpChallenge:
        entryPoint: web

http:
  routers:
    web-secure-router:
      {%- if cookiecutter.domain_name.count('.') == 1 %}
      rule: 'Host(`{{ cookiecutter.domain_name }}`) || Host(`www.{{ cookiecutter.domain_name }}`)'
      {%- else %}
      rule: 'Host(`{{ cookiecutter.domain_name }}`)'
      {%- endif %}
      entryPoints:
        - web-secure
      middlewares:
        - csrf
      service: django
      tls:
        # https://docs.traefik.io/master/routing/routers/#certresolver
        certResolver: letsencrypt
    {%- if cookiecutter.use_celery == 'y' %}

    flower-secure-router:
      rule: 'Host(`{{ cookiecutter.domain_name }}`)'
      entryPoints:
        - flower
      service: flower
      tls:
        # https://docs.traefik.io/master/routing/routers/#certresolver
        certResolver: letsencrypt
    {%- endif %}
    {%- if cookiecutter.cloud_provider == 'None' %}

    web-media-router:
      {%- if cookiecutter.domain_name.count('.') == 1 %}
      rule: '(Host(`{{ cookiecutter.domain_name }}`) || Host(`www.{{ cookiecutter.domain_name }}`)) && PathPrefix(`/media/`)'
      {%- else %}
      rule: 'Host(`{{ cookiecutter.domain_name }}`) && PathPrefix(`/media/`)'
      {%- endif %}
      entryPoints:
        - web-secure
      middlewares:
        - csrf
      service: django-media
      tls:
        certResolver: letsencrypt
    {%- endif %}

    {%- if cookiecutter.use_whitenoise == 'n' %}

    web-static-router:
      rule: 'Host(`{{ cookiecutter.domain_name }}`) && (PathPrefix(`/static/`) || PathPrefix(`/docs/`))'
      entryPoints:
        - web-secure
      middlewares:
        - csrf
        - security-headers
      service: django-static
      tls:
        certResolver: letsencrypt
    {%- endif %}

    {%- if cookiecutter.use_mosquitto == 'y' %}

    mqtt-secure-router:
      rule: 'Host(`{{ cookiecutter.domain_name }}`) && PathPrefix(`/mqtt`)'
      entryPoints:
        - web-secure
      service: mqtt
      tls:
        certResolver: letsencrypt

    {%- endif %}

  middlewares:
    csrf:
      # https://docs.traefik.io/master/middlewares/headers/#hostsproxyheaders
      # https://docs.djangoproject.com/en/dev/ref/csrf/#ajax
      headers:
        hostsProxyHeaders: ['X-CSRFToken']

    {%- if cookiecutter.use_whitenoise == 'n' %}
    security-headers:
      headers:
        # browserXssFilter: true
        customBrowserXSSValue: 0
        contentTypeNosniff: true
        frameDeny: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 2592000
        referrerPolicy: 'same-origin'
        contentSecurityPolicy: "default-src 'self' data: 'unsafe-inline'; script-src 'self' 'unsafe-inline' player.vimeo.com connect.facebook.net cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' fonts.googleapis.com cdn.jsdelivr.net; img-src 'self' data: cdn.jsdelivr.net; font-src 'self' fonts.gstatic.com; connect-src 'self' wss: o300282.ingest.sentry.io; media-src 'self' player.vimeo.com; frame-src player.vimeo.com; worker-src blob:; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content; base-uri 'self'"
        permissionsPolicy: 'accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()'
    {%- endif %}

  services:
    django:
      loadBalancer:
        servers:
          - url: http://django:5000
    {%- if cookiecutter.use_celery == 'y' %}

    flower:
      loadBalancer:
        servers:
          - url: http://flower:5555
    {%- endif %}
    {%- if cookiecutter.cloud_provider == 'None' %}

    django-media:
      loadBalancer:
        servers:
          - url: http://nginx:80
    {%- endif %}

    {%- if cookiecutter.use_whitenoise == 'n' %}

    django-static:
      loadBalancer:
        servers:
          - url: http://nginx:80
    {%- endif %}

    {%- if cookiecutter.use_mosquitto == 'y' %}

    mqtt:
      loadBalancer:
        servers:
          - url: http://mosquitto:9001
    {%- endif %}

{%- if cookiecutter.use_mosquitto == 'y' %}
tcp:
  routers:
    mqtt-tcp-router:
      rule: 'HostSNI(`*`)'
      entryPoints:
        - mqtt
      service: mqtt-tcp-service

    mqtt-tcp-secure-router:
      rule: 'HostSNI(`{{ cookiecutter.domain_name }}`)'
      entryPoints:
        - mqtt-secure
      service: mqtt-tcp-secure-service
      tls:
        certResolver: letsencrypt

  services:
    mqtt-tcp-service:
      loadBalancer:
        servers:
          - address: mosquitto:1883

    mqtt-tcp-secure-service:
      loadBalancer:
        servers:
          - address: mosquitto:8883
{%- endif %}

providers:
  # https://docs.traefik.io/master/providers/file/
  file:
    filename: /etc/traefik/traefik.yml
    watch: true
